# auto-engine 产品需求说明书

## 项目背景

### 行业背景

随着软件开发行业的快速发展，自动化测试已成为保障软件质量的重要手段。传统的自动化测试平台往往存在以下痛点：

- **资源限制**：测试执行受限于平台服务器资源，高并发场景下需要排队等待
- **环境依赖**：测试执行环境与平台紧耦合，难以适应复杂的网络环境和部署场景
- **扩展性差**：难以快速扩展测试执行能力，无法灵活应对不同规模的测试需求
- **维护成本高**：集中式架构导致维护复杂，故障影响面大

### 技术背景

LiuMa测试平台采用分布式架构设计，将测试执行引擎从平台主体中独立出来，形成了"平台+引擎"的创新模式。平台负责测试用例管理、任务调度和结果汇总，而引擎专注于测试执行，两者通过标准化的API接口进行通信。

### 项目定位

LiuMa-engine是LiuMa测试平台的核心执行引擎，作为独立的Python应用程序，承担着所有测试用例的实际执行工作。引擎采用注册制设计，支持多引擎并发执行，可以部署在不同的网络环境中，为平台提供强大的测试执行能力。

## 需求描述

### 功能需求

#### 核心功能需求

**多端测试支持**

- 支持API接口测试，基于requests库实现HTTP/HTTPS协议的接口请求
- 支持WEB自动化测试，基于Selenium WebDriver实现浏览器自动化操作
- 支持APP自动化测试，基于Uiautomator2（Android）和Facebook-wda（iOS）实现移动端自动化

**智能断言机制**

- 提供丰富的断言类型，包括相等、包含、大小比较、类型判断等
- 支持复杂数据结构的断言，如JSON对象、数组、嵌套结构
- 支持自定义断言逻辑，满足特殊业务场景需求

**灵活的参数管理**

- 支持关联参数提取和传递，实现测试用例间的数据流转
- 支持公共参数管理，提高参数复用性
- 支持动态参数生成，包括时间戳、随机数、UUID等

**脚本扩展能力**

- 支持前置/后置Python脚本执行，实现复杂的业务逻辑
- 支持前置/后置SQL脚本执行，实现数据库操作
- 提供丰富的内置函数库，简化常用操作

**流程控制功能**

- 支持条件控制器，实现基于条件的用例执行
- 支持循环控制器，实现批量数据的循环测试
- 支持用例依赖管理，确保执行顺序的正确性

#### 系统集成需求

**平台通信**

- 实现与LiuMa平台的标准化API通信
- 支持引擎注册和心跳保活机制
- 支持任务获取和结果上报的异步处理

**配置管理**

- 支持灵活的配置文件管理，包括平台连接、引擎参数等
- 支持多环境配置切换，适应不同的部署场景
- 支持运行时配置更新，无需重启引擎

**日志监控**

- 提供完整的执行日志记录，包括请求详情、响应内容、错误信息等
- 支持多级别日志输出，便于问题定位和性能分析
- 支持日志文件轮转，避免磁盘空间占用过大

### 非功能需求

#### 性能需求

**并发处理能力**

- 单引擎支持多任务并发执行，提高测试效率
- 支持多引擎集群部署，实现水平扩展
- 优化资源使用，确保在有限资源下的最佳性能表现

**响应时间要求**

- 引擎启动时间不超过30秒
- 任务获取响应时间不超过5秒
- 结果上报响应时间不超过10秒

#### 可靠性需求

**容错机制**

- 支持网络异常的自动重试和恢复
- 支持任务执行失败的错误处理和状态回滚
- 支持引擎异常退出的自动重启机制

**数据一致性**

- 确保测试结果的准确性和完整性
- 支持事务管理，保证数据操作的原子性
- 支持结果数据的校验和纠错

#### 兼容性需求

**操作系统兼容**

- 支持Windows、macOS、Linux等主流操作系统
- 支持Docker容器化部署
- 支持云环境和本地环境的灵活部署

**版本兼容**

- 支持Python 3.8及以上版本
- 支持主流浏览器的最新版本（Chrome、Firefox、Edge等）
- 支持Android 5.0+和iOS 10.0+设备

#### 安全需求

**通信安全**

- 支持HTTPS加密通信，保障数据传输安全
- 支持引擎身份认证，防止未授权访问
- 支持敏感信息的加密存储

**权限控制**

- 支持基于角色的访问控制
- 支持操作审计和日志记录
- 支持安全配置的强制检查

## 实现功能

### 核心执行模块

#### 测试用例执行引擎（Case）

**功能描述**：作为测试用例执行的核心控制器，负责协调不同类型测试用例的执行流程。

**主要特性**：

- 支持API、WEB、APP三种测试类型的统一调度
- 提供完整的测试生命周期管理（初始化、执行、清理）
- 实现测试事务管理，支持事务的创建、更新和状态跟踪
- 提供丰富的日志记录功能，包括调试日志和错误日志
- 支持测试结果的实时处理和状态更新

**技术实现**：

- 基于unittest.TestCase框架构建
- 采用工厂模式动态创建不同类型的测试执行器
- 实现异常处理机制，确保测试执行的稳定性

#### API测试执行器（ApiTestCase）

**功能描述**：专门负责API接口测试的执行，支持HTTP/HTTPS协议的各种请求方式。

**主要特性**：

- 支持GET、POST、PUT、DELETE等HTTP方法
- 支持请求头、请求体、查询参数、路径参数的灵活配置
- 支持Session管理，实现登录状态的保持
- 支持文件上传和下载功能
- 支持代理设置和SSL证书验证
- 支持请求超时和重试机制

**技术实现**：

- 基于requests库实现HTTP请求
- 支持JSON、XML、Form等多种数据格式
- 实现请求和响应的完整记录

#### WEB测试执行器（WebTestCase）

**功能描述**：基于Selenium WebDriver实现的WEB自动化测试执行器。

**主要特性**：

- 支持Chrome、Firefox、Edge等主流浏览器
- 支持无头模式和远程WebDriver
- 支持页面元素的多种定位方式（ID、XPath、CSS选择器等）
- 支持页面操作（点击、输入、滚动、截图等）
- 支持页面等待和同步机制
- 支持多窗口和多标签页管理

**技术实现**：

- 基于Selenium WebDriver框架
- 实现WebDriver的生命周期管理
- 支持浏览器启动参数的自定义配置

#### APP测试执行器（AppTestCase）

**功能描述**：支持Android和iOS移动应用的自动化测试执行。

**主要特性**：

- Android平台基于Uiautomator2实现
- iOS平台基于Facebook-wda实现
- 支持应用安装、启动、卸载等生命周期管理
- 支持控件的多种定位方式（资源ID、文本、XPath等）
- 支持手势操作（点击、滑动、拖拽等）
- 支持设备信息获取和屏幕截图

**技术实现**：

- 集成uiautomator2和facebook-wda库
- 实现设备连接和会话管理
- 支持多设备并发测试

### 断言验证模块

#### 智能断言引擎（Assert）

**功能描述**：提供强大而灵活的断言验证能力，支持各种数据类型和比较方式。

**主要特性**：

- **基础断言**：相等、不相等、包含、不包含
- **数值断言**：大于、小于、等于、介于、接近
- **类型断言**：类型检查、空值检查、布尔值检查
- **字符串断言**：开头匹配、结尾匹配、正则匹配、长度检查
- **集合断言**：列表长度、成员检查、子集检查
- **复杂结构断言**：JSON对象、嵌套数组、字典结构

**技术实现**：

- 基于assertpy库构建
- 实现类型自动转换和智能比较
- 提供详细的断言失败信息

### 参数管理模块

#### 关联参数处理

**功能描述**：实现测试用例间的数据传递和参数关联。

**主要特性**：

- 支持JSONPath、XPath、正则表达式等多种提取方式
- 支持参数的动态生成和计算
- 支持参数的作用域管理（用例级、集合级、全局级）
- 支持参数的类型转换和格式化

#### 公共参数管理

**功能描述**：提供全局参数的统一管理和使用。

**主要特性**：

- 支持环境变量的动态加载
- 支持参数的加密存储和安全访问
- 支持参数的版本管理和回滚

### 脚本扩展模块

#### Python脚本执行器

**功能描述**：支持自定义Python脚本的执行，扩展测试能力。

**主要特性**：

- 支持前置脚本和后置脚本
- 提供丰富的内置函数库
- 支持脚本间的参数传递
- 支持脚本执行的安全沙箱

**内置函数库**：

- 时间函数：当前时间、时间格式化、时间计算
- 字符串函数：编码解码、加密解密、格式化
- 数学函数：随机数生成、数值计算、统计函数
- 网络函数：URL编码、IP地址处理、域名解析

#### SQL脚本执行器

**功能描述**：支持数据库操作脚本的执行，实现数据验证和准备。

**主要特性**：

- 支持MySQL、PostgreSQL、SQLite等主流数据库
- 支持查询结果的参数化提取
- 支持事务管理和回滚机制
- 支持连接池管理，提高执行效率

### 流程控制模块

#### 条件控制器

**功能描述**：基于条件表达式控制测试用例的执行流程。

**主要特性**：

- 支持多种比较操作符（==、!=、>、<、>=、<=）
- 支持逻辑操作符（and、or、not）
- 支持复杂表达式的嵌套和组合
- 支持动态参数的条件判断

#### 循环控制器

**功能描述**：实现测试用例的循环执行，支持数据驱动测试。

**主要特性**：

- 支持固定次数循环和条件循环
- 支持循环变量的管理和使用
- 支持嵌套循环和复杂循环逻辑
- 支持循环中断和继续控制

### 平台集成模块

#### 引擎注册与通信（Api）

**功能描述**：实现引擎与平台的通信和协调。

**主要特性**：

- 支持引擎的自动注册和身份验证
- 支持心跳保活和状态同步
- 支持任务的实时获取和分发
- 支持结果的异步上报和确认

**技术实现**：

- 基于RESTful API设计
- 支持HTTPS加密通信
- 实现请求重试和容错机制

#### 任务调度与执行

**功能描述**：负责测试任务的调度和执行管理。

**主要特性**：

- 支持多任务并发执行
- 支持任务优先级管理
- 支持任务执行状态的实时跟踪
- 支持任务执行结果的详细记录

### 结果处理模块

#### 测试报告生成（Report）

**功能描述**：负责测试结果的收集、处理和上报。

**主要特性**：

- 支持实时结果监控和上报
- 支持测试截图的自动保存和关联
- 支持执行日志的结构化记录
- 支持测试数据的统计和分析

#### 错误处理与恢复

**功能描述**：提供完善的错误处理和恢复机制。

**主要特性**：

- 支持异常的自动捕获和分类
- 支持错误信息的详细记录和分析
- 支持失败用例的自动重试
- 支持执行状态的自动恢复

### 配置管理模块

#### 配置文件管理（Config）

**功能描述**：提供灵活的配置管理能力。

**主要特性**：

- 支持INI格式的配置文件
- 支持配置的分层管理（全局、环境、用例）
- 支持配置的动态加载和更新
- 支持配置的验证和默认值处理

**配置项说明**：

- 平台连接配置：URL、认证信息、超时设置
- 引擎运行配置：并发数、重试次数、日志级别
- 浏览器配置：驱动路径、启动参数、无头模式
- 数据库配置：连接字符串、连接池设置、超时配置

### 日志监控模块

#### 日志记录系统

**功能描述**：提供完整的日志记录和管理功能。

**主要特性**：

- 支持多级别日志输出（DEBUG、INFO、WARNING、ERROR）
- 支持日志文件的自动轮转和压缩
- 支持日志格式的自定义配置
- 支持日志的实时查看和搜索

#### 性能监控

**功能描述**：监控引擎的运行性能和资源使用情况。

**主要特性**：

- 支持CPU、内存、磁盘使用率监控
- 支持网络请求的性能统计
- 支持测试执行时间的详细记录
- 支持性能数据的可视化展示

### 扩展功能模块

#### 插件系统

**功能描述**：提供插件化的扩展机制，支持自定义功能开发。

**主要特性**：

- 支持自定义断言插件
- 支持自定义函数插件
- 支持自定义协议插件
- 支持插件的热加载和卸载

#### 数据驱动支持

**功能描述**：支持多种数据源的数据驱动测试。

**主要特性**：

- 支持Excel、CSV、JSON等文件格式
- 支持数据库查询结果作为数据源
- 支持API响应数据作为数据源
- 支持数据的动态生成和转换

通过以上功能模块的实现，LiuMa-engine为LiuMa测试平台提供了强大、灵活、可扩展的测试执行能力，能够满足各种复杂的自动化测试需求，为软件质量保障提供了可靠的技术支撑。


# 文档撰写成果

创建了完整的 `PRD.md` 文档，内容包括：

项目背景部分

- 详细阐述了自动化测试行业的痛点和技术背景
- 明确了LiuMa-engine作为分布式测试执行引擎的项目定位
- 突出了"平台+引擎"创新架构的优势
  需求描述部分
- 功能需求 ：涵盖多端测试支持、智能断言机制、参数管理、脚本扩展、流程控制、系统集成等核心功能
- 非功能需求 ：详细描述了性能、可靠性、兼容性、安全性等方面的具体要求
  实现功能部分
- 核心执行模块 ：详细描述了 `Case` 、 `ApiTestCase` 、WebTestCase、AppTestCase等执行器
- 断言验证模块 ：基于 `Assert` 类的智能断言引擎
- 参数管理模块 ：关联参数和公共参数的处理机制
- 脚本扩展模块 ：Python和SQL脚本执行器
- 流程控制模块 ：条件控制器和循环控制器
- 平台集成模块 ：基于 `Api` 的引擎注册与通信
- 结果处理模块 ：基于 `Report` 的测试报告生成
- 配置管理模块 ：基于 `Config` 的配置文件管理
- 扩展功能模块 ：插件系统和数据驱动支持
