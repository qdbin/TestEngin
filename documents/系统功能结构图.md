# auto-engine 系统功能结构图

## 系统整体架构图

```mermaid
graph TB
    subgraph "LiuMa-engine 自动化测试引擎"
        A[启动入口 startup.py] --> B[引擎启动模块 Start]
      
        subgraph "核心管理层"
            B --> C[配置管理 Config]
            B --> D[平台通信 Api]
            B --> E[任务管理 Setting]
            B --> F[结果处理 Report]
        end
      
        subgraph "测试执行层"
            E --> G[测试运行 Run]
            G --> H[测试用例 Case]
            H --> I[API测试 ApiTestCase]
            H --> J[WEB测试 WebTestCase]
            H --> K[APP测试 AppTestCase]
        end
      
        subgraph "支撑服务层"
            L[断言引擎 Assert]
            M[模板引擎 Template]
            N[日志系统 Logger]
            O[结果收集 Result]
        end
      
        subgraph "外部接口层"
            P[测试平台]
            Q[WebSocket心跳]
            R[HTTP API]
        end
    end
  
    P --> D
    Q --> B
    R --> D
  
    I --> L
    J --> L
    K --> L
  
    I --> M
    J --> M
    K --> M
  
    G --> O
    O --> F
  
    B --> N
    E --> N
    F --> N
```

## 核心功能模块详细结构图

### 1. 引擎启动与管理模块

```mermaid
graph TB
    subgraph "引擎启动管理 (Start)"
        A[main 主入口] --> B[send_heartbeat 心跳维护]
        A --> C[fetch_task 任务拉取]
        A --> D[monitor_message 消息监听]
      
        B --> E[WebSocket连接]
        C --> F[HTTP任务获取]
        D --> G[消息队列处理]
      
        G --> H[run_test 测试执行]
        G --> I[push_result 结果推送]
        G --> J[upload_image 图片上传]
        G --> K[stop_task 任务终止]
      
        H --> L[多进程执行]
        I --> M[Report监控]
        J --> N[截图上传]
        K --> O[进程管理]
    end
```

### 2. 配置管理模块

```mermaid
graph TB
    subgraph "配置管理 (Config)"
        A[IniReader INI文件读取] --> B[配置文件解析]
        B --> C[平台连接配置]
        B --> D[引擎运行配置]
        B --> E[浏览器配置]
        B --> F[数据库配置]
      
        C --> G[platform_url 平台地址]
        C --> H[engine_code 引擎代码]
        C --> I[engine_key 引擎密钥]
      
        D --> J[max_run 最大运行数]
        D --> K[request_headers 请求头]
      
        E --> L[browser_opt 浏览器选项]
        E --> M[browser_path 浏览器路径]
      
        F --> N[数据库连接参数]
    end
```

### 3. 平台通信模块

```mermaid
graph TB
    subgraph "平台通信 (Api)"
        A[Api 基础HTTP类] --> B[POST请求处理]
        A --> C[GET请求处理]
        A --> D[请求头管理]
        A --> E[Token保存]
      
        F[Api 平台接口] --> G[apply_token Token申请]
        F --> H[fetch_task 任务获取]
        F --> I[upload_result 结果上传]
        F --> J[complete_task 任务完成]
        F --> K[download_task_file 任务文件下载]
        F --> L[download_test_file 测试文件下载]
        F --> M[upload_screen_shot 截图上传]
      
        G --> N[Token刷新机制]
        H --> O[重试机制]
        I --> P[批量结果上传]
        J --> Q[任务状态反馈]
        K --> R[ZIP文件下载]
        L --> S[测试数据下载]
        M --> T[图片文件上传]
    end
```

### 4. 任务管理与执行模块

```mermaid
graph TB
    subgraph "任务管理 (Setting)"
        A[task_analysis 任务分析] --> B[data_pull 数据拉取]
        A --> C[file_unzip 文件解压]
        A --> D[测试计划生成]
      
        B --> E[ZIP文件下载]
        C --> F[测试数据解压]
        D --> G[用例集合分组]
        D --> H[测试用例配置]
      
        I[create_thread 线程创建] --> J[ThreadPoolExecutor 线程池]
        I --> K[任务重试机制]
        I --> L[失败用例重跑]
      
        J --> M[Run 测试运行]
        K --> N[read_fail_case 失败用例读取]
        L --> O[多轮执行控制]
      
        P[Session API会话] --> Q[requests.Session]
        R[Driver WEB驱动] --> S[Selenium配置]
    end
```

### 5. 测试执行核心模块

```mermaid
graph TB
    subgraph "测试执行核心"
        A[Run 测试运行器] --> B[unittest.TestSuite 测试套件]
        B --> C[Case 测试用例基类]
      
        C --> D[testEntrance 测试入口]
        C --> E[debugLog 调试日志]
        C --> F[errorLog 错误日志]
        C --> G[recordTransDuring 事务记录]
        C --> H[saveScreenShot 截图保存]
        C --> I[handleResult 结果处理]
      
        D --> J[ApiTestCase API测试]
        D --> K[WebTestCase WEB测试]
        D --> L[AppTestCase APP测试]
      
        J --> M[HTTP请求执行]
        J --> N[JSON响应处理]
      
        K --> O[Selenium WebDriver]
        K --> P[浏览器操作]
      
        L --> Q[uiautomator2 Android]
        L --> R[facebook-wda iOS]
      
        M --> S[Result 结果收集]
        O --> S
        Q --> S
        R --> S
    end
```

### 6. 断言引擎模块

```mermaid
graph TB
    subgraph "断言引擎 (Assert)"
        A[Assert 断言处理器] --> B[字符串断言]
        A --> C[数值断言]
        A --> D[列表断言]
        A --> E[字典断言]
        A --> F[类型断言]
      
        B --> G[isEqual 相等判断]
        B --> H[isContain 包含判断]
        B --> I[isEmpty 为空判断]
        B --> J[startWith 起始判断]
        B --> K[endWith 结束判断]
      
        C --> L[isPositive 正数判断]
        C --> M[isNegative 负数判断]
        C --> N[isGreaterThan 大于判断]
        C --> O[isBetween 区间判断]
      
        D --> P[listLenEqual 长度相等]
        D --> Q[isInList 在列表中]
      
        E --> R[dictKeyExist 键存在]
      
        F --> S[数据类型转换]
        S --> T[str2none 空值转换]
        S --> U[str2bool 布尔转换]
        S --> V[str2num 数值转换]
        S --> W[str2list 列表转换]
        S --> X[str2dict 字典转换]
    end
```

### 7. 模板引擎模块

```mermaid
graph TB
    subgraph "模板引擎 (Template)"
        A[Template 模板处理器] --> B[参数渲染]
        A --> C[函数执行]
        A --> D[表达式解析]
      
        B --> E[关联参数 context]
        B --> F[公共参数 params]
        B --> G[内置变量]
      
        C --> H[内置函数库]
        C --> I[自定义函数]
      
        D --> J[JSONPath解析]
        D --> K[变量替换]
      
        E --> L[接口响应关联]
        F --> M[全局参数管理]
        G --> N[请求信息变量]
      
        H --> O[时间函数]
        H --> P[字符串函数]
        H --> Q[加密函数]
      
        I --> R[用户扩展函数]
      
        J --> S[数据提取]
        K --> T[动态渲染]
      
        N --> U[_request_url]
        N --> V[_request_header]
        N --> W[_request_body]
        N --> X[_request_query]
    end
```

### 8. 测试用例执行器详细结构

```mermaid
graph TB
    subgraph "API测试执行器 (ApiTestCase)"
        A[execute 执行入口] --> B[before_execute 前置处理]
        A --> C[步骤循环执行]
        A --> D[after_execute 后置处理]
      
        B --> E[测试数据加载]
        B --> F[环境初始化]
      
        C --> G[步骤渲染]
        C --> H[HTTP请求发送]
        C --> I[响应处理]
        C --> J[断言验证]
        C --> K[参数关联]
        C --> L[条件控制]
        C --> M[循环控制]
      
        G --> N[Template渲染]
        H --> O[requests执行]
        I --> P[JSON解析]
        J --> Q[Assert断言]
        K --> R[响应数据提取]
        L --> S[条件判断]
        M --> T[循环次数控制]
      
        D --> U[会话清理]
        D --> V[结果汇总]
    end
  
    subgraph "WEB测试执行器 (WebTestCase)"
        AA[execute 执行入口] --> BB[before_execute 前置处理]
        AA --> CC[步骤循环执行]
        AA --> DD[after_execute 后置处理]
      
        BB --> EE[WebDriver初始化]
        BB --> FF[浏览器启动]
      
        CC --> GG[元素定位]
        CC --> HH[页面操作]
        CC --> II[断言验证]
        CC --> JJ[截图保存]
      
        GG --> KK[Selenium定位器]
        HH --> LL[点击/输入/滚动]
        II --> MM[页面元素断言]
        JJ --> NN[失败截图]
      
        DD --> OO[浏览器关闭]
        DD --> PP[驱动清理]
    end
  
    subgraph "APP测试执行器 (AppTestCase)"
        AAA[execute 执行入口] --> BBB[before_execute 前置处理]
        AAA --> CCC[步骤循环执行]
        AAA --> DDD[after_execute 后置处理]
      
        BBB --> EEE[设备连接]
        BBB --> FFF[应用启动]
      
        CCC --> GGG[元素定位]
        CCC --> HHH[设备操作]
        CCC --> III[断言验证]
        CCC --> JJJ[截图保存]
      
        GGG --> KKK[uiautomator2/WDA定位]
        HHH --> LLL[点击/滑动/输入]
        III --> MMM[界面元素断言]
        JJJ --> NNN[操作截图]
      
        DDD --> OOO[应用关闭]
        DDD --> PPP[设备断开]
    end
```

### 9. 日志与监控模块

```mermaid
graph TB
    subgraph "日志系统 (Logger)"
        A[Logger 日志处理器] --> B[日志格式化]
        A --> C[文件处理器]
        A --> D[线程安全]
      
        B --> E[时间戳格式]
        B --> F[日志级别]
        B --> G[消息内容]
      
        C --> H[日志文件创建]
        C --> I[目录自动创建]
        C --> J[UTF-8编码]
      
        D --> K[RLock线程锁]
      
        L[DebugLogger 调试日志] --> M[INFO级别记录]
        N[ErrorLogger 错误日志] --> O[ERROR级别记录]
      
        M --> P[engine_run.log]
        O --> P
    end
  
    subgraph "结果监控 (Report)"
        Q[monitor_result 结果监控] --> R[消息队列监听]
        Q --> S[结果批量上传]
        Q --> T[任务状态管理]
      
        R --> U[case_result_queue]
        S --> V[upload_result API调用]
        T --> W[任务完成通知]
      
        U --> X[测试结果接收]
        V --> Y[批量结果推送]
        W --> Z[post_stop 清理]
      
        Z --> AA[complete_task 任务完成]
        Z --> BB[测试数据清理]
    end
```

### 10. 数据流转图

```mermaid
sequenceDiagram
    participant P as 测试平台
    participant E as LiuMa-engine
    participant T as 任务管理
    participant R as 测试执行
    participant A as 断言引擎
    participant L as 日志系统
  
    P->>E: WebSocket心跳连接
    P->>E: 下发测试任务
    E->>T: 任务分析与数据拉取
    T->>T: 解压测试数据
    T->>T: 生成测试计划
    T->>R: 创建执行线程
  
    loop 测试执行循环
        R->>R: 加载测试用例
        R->>A: 执行断言验证
        R->>L: 记录执行日志
        R->>E: 推送执行结果
    end
  
    E->>P: 批量上传测试结果
    E->>P: 上传截图文件
    E->>P: 任务完成通知
    E->>E: 清理测试数据
```

## 技术架构说明

### 核心技术栈

- **基础框架**: Python + unittest
- **API测试**: requests
- **WEB测试**: Selenium WebDriver
- **APP测试**: uiautomator2 (Android) + facebook-wda (iOS)
- **断言库**: assertpy
- **模板引擎**: 自研Template引擎
- **通信协议**: WebSocket + HTTP/HTTPS
- **并发处理**: ThreadPoolExecutor
- **配置管理**: INI格式配置文件

### 设计特点

1. **模块化设计**: 各功能模块职责清晰，低耦合高内聚
2. **多协议支持**: 支持API、WEB、APP三种测试类型
3. **智能断言**: 基于assertpy的智能断言引擎
4. **参数化测试**: 支持关联参数和公共参数管理
5. **模板渲染**: 强大的表达式和函数支持
6. **并发执行**: 基于线程池的高效并发执行
7. **实时监控**: WebSocket心跳和实时结果上报
8. **容错机制**: 完善的异常处理和重试机制

### 扩展能力

- **插件系统**: 支持自定义函数和断言扩展
- **数据驱动**: 支持多种数据源的数据驱动测试
- **流程控制**: 支持条件判断和循环控制
- **脚本扩展**: 支持Python和SQL脚本执行
- **平台集成**: 标准化的平台接口，易于集成


# 系统功能结构图创建完成

我已经成功为LiuMa-engine项目创建了详细的 系统功能结构图.md 文档，该文档包含以下核心内容：

### 📊 完成的图表内容

1. 系统整体架构图

- 展示了引擎的四层架构：核心管理层、测试执行层、支撑服务层、外部接口层
- 清晰描述了各模块间的依赖关系和数据流向

2. 核心功能模块详细结构图（10个子图）

- 引擎启动与管理模块 ：Start的完整工作流程
- 配置管理模块 ：Config的配置项分类和管理机制
- 平台通信模块 ：Api的接口功能和通信机制
- 任务管理与执行模块 ：Setting的任务分析和线程管理
- 测试执行核心模块 ：Run和Case的执行流程
- 断言引擎模块 ：Assert的断言类型和数据转换
- 模板引擎模块 ：Template的参数渲染和函数执行
- 测试用例执行器详细结构 ：API/WEB/APP三种测试类型的执行流程
- 日志与监控模块 ：Logger和Report的功能实现
- 数据流转图 ：完整的测试执行时序图

### 🔧 技术架构说明

核心技术栈 ：Python + unittest + requests + Selenium + uiautomator2/facebook-wda

设计特点 ：

- 模块化设计，职责清晰
- 多协议支持（API/WEB/APP）
- 智能断言引擎
- 参数化测试支持
- 强大的模板渲染能力
- 高效并发执行
- 实时监控机制
- 完善的容错机制

### 📁 文档特色

1. 层次清晰 ：从整体架构到具体模块，逐层深入
2. 逻辑严谨 ：准确反映了代码中各模块的实际关系
3. 内容详细 ：涵盖了所有核心功能和关键流程
4. 易于理解 ：使用Mermaid语法，图表直观清晰
5. 实用性强 ：既有宏观架构，又有微观实现细节
